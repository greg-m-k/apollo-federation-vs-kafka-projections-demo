# Docker Compose for Apollo Federation vs Kafka Projections Demo
# Run with: docker-compose -f docker-compose.comparison.yml up

services:
  # =============================================================================
  # SHARED INFRASTRUCTURE
  # =============================================================================

  # PostgreSQL for Federation subgraphs
  postgres-federation:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_MULTIPLE_DATABASES: hr_db,employment_db,security_db
    volumes:
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
      - postgres-federation-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PostgreSQL for Kafka services and projections
  postgres-kafka:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      POSTGRES_MULTIPLE_DATABASES: hr_events_db,employment_events_db,security_events_db,projections_db
    volumes:
      - ./scripts/init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
      - postgres-kafka-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Kafka (KRaft mode - no Zookeeper)
  kafka:
    image: apache/kafka:3.7.0
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_LOG_DIRS=/var/lib/kafka/data
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
    ports:
      - "9092:9092"
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10

  # Kafka init - creates required internal topics
  kafka-init:
    image: apache/kafka:3.7.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating Kafka topics..."
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic __consumer_offsets --partitions 50 --replication-factor 1 --config cleanup.policy=compact
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic events.hr.person --partitions 1 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic events.employment.employee --partitions 1 --replication-factor 1
        /opt/kafka/bin/kafka-topics.sh --bootstrap-server kafka:9092 --create --if-not-exists --topic events.security.badge --partitions 1 --replication-factor 1
        echo "Kafka topics created successfully"
    restart: "no"

  # =============================================================================
  # FEDERATION ARCHITECTURE (GraphQL)
  # =============================================================================

  hr-subgraph:
    build:
      context: ./services/federation/hr-subgraph
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-federation
      DB_PORT: 5432
      DB_NAME: hr_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
    ports:
      - "8091:8080"
    depends_on:
      postgres-federation:
        condition: service_healthy

  employment-subgraph:
    build:
      context: ./services/federation/employment-subgraph
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-federation
      DB_PORT: 5432
      DB_NAME: employment_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
    ports:
      - "8092:8080"
    depends_on:
      postgres-federation:
        condition: service_healthy

  security-subgraph:
    build:
      context: ./services/federation/security-subgraph
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-federation
      DB_PORT: 5432
      DB_NAME: security_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
    ports:
      - "8093:8080"
    depends_on:
      postgres-federation:
        condition: service_healthy

  router:
    image: ghcr.io/apollographql/router:v1.57.1
    volumes:
      - ./router/federation/router.yaml:/dist/config/router.yaml
      - ./router/federation/supergraph.graphql:/dist/config/supergraph.graphql
    ports:
      - "4000:4000"
      - "8088:8088"
    command: ["--config", "/dist/config/router.yaml", "--supergraph", "/dist/config/supergraph.graphql"]
    depends_on:
      - hr-subgraph
      - employment-subgraph
      - security-subgraph

  # =============================================================================
  # KAFKA PROJECTIONS ARCHITECTURE (Event-Driven)
  # =============================================================================

  hr-events-service:
    build:
      context: ./services/kafka/hr-events-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-kafka
      DB_PORT: 5432
      DB_NAME: hr_events_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
      KAFKA_BOOTSTRAP: kafka:9092
    ports:
      - "8084:8080"
    depends_on:
      postgres-kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully

  employment-events-service:
    build:
      context: ./services/kafka/employment-events-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-kafka
      DB_PORT: 5432
      DB_NAME: employment_events_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
      KAFKA_BOOTSTRAP: kafka:9092
    ports:
      - "8085:8080"
    depends_on:
      postgres-kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully

  security-events-service:
    build:
      context: ./services/kafka/security-events-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-kafka
      DB_PORT: 5432
      DB_NAME: security_events_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
      KAFKA_BOOTSTRAP: kafka:9092
    ports:
      - "8086:8080"
    depends_on:
      postgres-kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully

  projection-consumer:
    build:
      context: ./services/kafka/projection-consumer
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-kafka
      DB_PORT: 5432
      DB_NAME: projections_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
      KAFKA_BOOTSTRAP: kafka:9092
    ports:
      - "8089:8080"
    depends_on:
      postgres-kafka:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
      hr-events-service:
        condition: service_started

  query-service:
    build:
      context: ./services/kafka/query-service
      dockerfile: src/main/docker/Dockerfile.jvm
    environment:
      DB_HOST: postgres-kafka
      DB_PORT: 5432
      DB_NAME: projections_db
      DB_USER: postgres
      DB_PASSWORD: postgres123
    ports:
      - "8090:8080"
    depends_on:
      projection-consumer:
        condition: service_started

  # =============================================================================
  # DASHBOARD
  # =============================================================================

  dashboard:
    build:
      context: ./dashboard
    ports:
      - "3000:80"
    depends_on:
      - router
      - query-service

volumes:
  postgres-federation-data:
  postgres-kafka-data:
  kafka-data:
